name: Security Audit

on:
  schedule:
    # 매주 월요일 03:00 UTC (한국시간 12:00)
    - cron: '0 3 * * 1'
  workflow_dispatch:
  push:
    branches:
      - main
      - dev
    paths:
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'packages/*/package.json'

jobs:
  audit:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest

    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run pnpm audit
        id: audit
        continue-on-error: true
        run: |
          set +e
          pnpm audit --json --audit-level=moderate 2>audit-stderr.log | tee audit-result.json
          AUDIT_EXIT_CODE=${PIPESTATUS[0]}
          set -e

          echo "audit_exit_code=$AUDIT_EXIT_CODE" >> $GITHUB_OUTPUT
          echo "Audit exit code: $AUDIT_EXIT_CODE"

      - name: Parse audit results
        id: check
        run: |
          set +e

          AUDIT_EXIT_CODE="${{ steps.audit.outputs.audit_exit_code }}"

          # audit 명령이 실패했는데 결과 파일이 없다면 워크플로우 실패
          if [ ! -f audit-result.json ]; then
            if [ "$AUDIT_EXIT_CODE" != "0" ]; then
              echo "::error::pnpm audit 실행 실패 (exit code: $AUDIT_EXIT_CODE)"
              exit 1
            fi
            echo "has_vulnerabilities=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # jq를 사용해서 취약점 개수 파싱
          HIGH=$(cat audit-result.json | jq -r '.metadata.vulnerabilities.high // 0' 2>/dev/null || echo "0")
          MODERATE=$(cat audit-result.json | jq -r '.metadata.vulnerabilities.moderate // 0' 2>/dev/null || echo "0")
          CRITICAL=$(cat audit-result.json | jq -r '.metadata.vulnerabilities.critical // 0' 2>/dev/null || echo "0")

          TOTAL=$((CRITICAL + HIGH + MODERATE))

          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "moderate=$MODERATE" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

          echo "취약점 요약: Critical=$CRITICAL, High=$HIGH, Moderate=$MODERATE, Total=$TOTAL"

          if [ $TOTAL -gt 0 ]; then
            echo "has_vulnerabilities=true" >> $GITHUB_OUTPUT
          else
            echo "has_vulnerabilities=false" >> $GITHUB_OUTPUT
          fi

          set -e

      - name: Create issue on vulnerabilities
        if: steps.check.outputs.has_vulnerabilities == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const date = new Date().toISOString().split('T')[0];
            const title = `[Security] pnpm audit 취약점 발견 - ${date}`;

            const critical = '${{ steps.check.outputs.critical }}';
            const high = '${{ steps.check.outputs.high }}';
            const moderate = '${{ steps.check.outputs.moderate }}';
            const total = '${{ steps.check.outputs.total }}';

            // audit 결과 요약 생성 (전체 JSON 대신 요약만)
            let auditData = '';
            try {
              const rawData = fs.readFileSync('audit-result.json', 'utf8');
              const parsed = JSON.parse(rawData);

              // npm v8+ vulnerabilities 구조와 npm v6 advisories 구조 모두 지원
              let vulnerabilities = [];

              // npm v8+ 구조: parsed.vulnerabilities
              if (parsed.vulnerabilities && typeof parsed.vulnerabilities === 'object') {
                vulnerabilities = Object.entries(parsed.vulnerabilities).map(([pkg, data]) => ({
                  title: data.name || pkg,
                  severity: data.severity,
                  module_name: pkg,
                  version: data.range || data.via?.[0]?.range || 'N/A',
                  url: data.via?.[0]?.url || (data.via?.[0] && typeof data.via[0] === 'string' ? `https://npmjs.com/advisories/${data.via[0]}` : 'N/A')
                }));
              }
              // npm v6 구조: parsed.advisories (fallback)
              else if (parsed.advisories && typeof parsed.advisories === 'object') {
                vulnerabilities = Object.values(parsed.advisories).map(adv => ({
                  title: adv.title,
                  severity: adv.severity,
                  module_name: adv.module_name,
                  version: adv.findings?.[0]?.version || 'N/A',
                  url: adv.url || 'N/A'
                }));
              }

              // 상위 10개 취약점만 추출
              const topVulns = vulnerabilities.slice(0, 10);
              if (topVulns.length > 0) {
                auditData = topVulns.map(vuln =>
                  `- **${vuln.title}** (${vuln.severity})\n  - Package: \`${vuln.module_name}@${vuln.version}\`\n  - More info: ${vuln.url}`
                ).join('\n\n');
              } else {
                auditData = '취약점 상세 정보를 파싱할 수 없습니다. 아티팩트를 확인하세요.';
              }
            } catch (e) {
              auditData = `취약점 상세 정보를 파싱할 수 없습니다. 에러: ${e.message}\n아티팩트를 확인하세요.`;
            }

            const body = `## 보안 취약점 자동 검사 결과

**검사 일시**: ${new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}
**워크플로우**: ${context.workflow}
**실행 번호**: #${context.runNumber}
**브랜치**: ${context.ref}

### 취약점 요약

| 심각도 | 개수 |
|--------|------|
| Critical | ${critical} |
| High | ${high} |
| Moderate | ${moderate} |
| **Total** | **${total}** |

### 발견된 취약점 (상위 10개)

${auditData}

### 조치 방법

1. 로컬에서 \`pnpm audit\` 실행하여 전체 취약점 확인
2. \`pnpm update\` 또는 \`pnpm audit fix\` 실행
3. 수동 업데이트가 필요한 경우 package.json 직접 수정
4. 수정 후 테스트 및 빌드 확인
5. PR 생성 및 머지

### 참고 링크

- [워크플로우 실행 로그](${context.payload.repository.html_url}/actions/runs/${context.runId})
- [전체 audit 결과 (아티팩트)](${context.payload.repository.html_url}/actions/runs/${context.runId}#artifacts)
- [pnpm audit 문서](https://pnpm.io/cli/audit)

---
자동 생성된 이슈입니다.
            `;

            // 기존 열린 보안 이슈가 있는지 확인 (security 라벨만으로 검색)
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes('[Security] pnpm audit 취약점 발견') &&
              issue.labels.some(label => label.name === 'automated')
            );

            if (existingIssue) {
              // 기존 이슈에 코멘트 추가
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `### 새로운 검사 결과 (${date})

${body}`
              });
              console.log(`기존 이슈 #${existingIssue.number}에 코멘트 추가됨`);
            } else {
              // 새 이슈 생성
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security', 'automated', 'dependencies']
              });
              console.log(`새 이슈 #${issue.data.number} 생성됨`);
            }

      - name: Upload audit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-results
          path: |
            audit-result.json
            audit-stderr.log
          retention-days: 30

      - name: Fail workflow if vulnerabilities found
        if: steps.check.outputs.has_vulnerabilities == 'true'
        run: |
          echo "::error::보안 취약점이 발견되었습니다. 이슈를 확인하고 조치하세요."
          exit 1
